
from fastapi import FastAPI, File, UploadFile, Form, HTTPException, Request,Depends
from fastapi.responses import JSONResponse
from fastapi.staticfiles import StaticFiles
from fastapi.middleware.cors import CORSMiddleware
from fastapi.encoders import jsonable_encoder

from sqlalchemy.orm import Session
from SQLService import Crud, Schemas
from SQLService.Conn import SessionLocal

from ChatModel import Spark,Kimi,Qwen

import json
import shutil
import datetime

from docx import Document

"""
               _oo0oo_
              o8888888o
              88" . "88
              (| -_- |)
              0\  =  /0
            ___/`---'\___
          .' \\|     |// '.
         / \\|||  :  |||// \
        / _||||| -:- |||||- \
       |   | \\\  -  /// |   |
       | \_|  ''\---/''  |_/ |
       \  .-\__  '-'  ___/-. /
     ___'. .'  /--.--\  `. .'___
  ."" '<  `.___\_<|>_/___.' >' "".
 | | :  `- \`.;`\ _ /`;.`/ - ` : | |
 \  \ `_.   \_ __\ /__ _/   .-` /  /
=====`-.____`.___ \_____/___.-`___.-'=====
               `=---='


~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    ä½›ç¥–ä¿ä½‘ æ²¡æœ‰BUG
"""


app = FastAPI(title='AIç”³è¯·ä¹¦APIæ–‡æ¡£', description='ğŸ™ğŸ™ğŸ™  æ„¿å¤©å ‚æ²¡æœ‰BUG')

app.mount("/Files", StaticFiles(directory="Files"), name="Files")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"]
)


def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# å¢åŠ è®°å½•
def addLog(request,type,input,output,state,db):
    log_dict={
        "username":request.headers.get("Authorization"),
        "type":type,
        "input": jsonable_encoder(input),
        "output":output,
        "state":state,
        "time":datetime.datetime.now()
    }
    Crud.addLogr(db,log_dict)

# -------- ç”¨æˆ·è¡¨ -------- ç”¨æˆ·è¡¨ -------- ç”¨æˆ·è¡¨ -------- ç”¨æˆ·è¡¨ -------- ç”¨æˆ·è¡¨ -------- ç”¨æˆ·è¡¨ -------- ç”¨æˆ·è¡¨ -------- ç”¨æˆ·è¡¨
@app.post("/login", tags=["ç”¨æˆ·è¡¨"], summary="ç™»å½•")
def login(data: Schemas.LoginUser, db: Session = Depends(get_db)):
    user = Crud.getUser(db, data.username)
    if user is None:
        raise HTTPException(status_code=404, detail="ç”¨æˆ·ä¸å­˜åœ¨ï¼")
    else:
        if user.password != data.password:
            raise HTTPException(status_code=401, detail="è´¦å·æˆ–å¯†ç é”™è¯¯!")
        else:
            return user

# ---------- é¡¹ç›®è¡¨ ---------- é¡¹ç›®è¡¨ ---------- é¡¹ç›®è¡¨ ---------- é¡¹ç›®è¡¨ ---------- é¡¹ç›®è¡¨ ---------- é¡¹ç›®è¡¨ ---------- é¡¹ç›®è¡¨

# åˆ›å»ºé¡¹ç›®
@app.get("/addItem", tags=["é¡¹ç›®è¡¨"], summary="åˆ›å»ºé¡¹ç›®")
def addItem(username:str, db: Session = Depends(get_db)):
    user = Crud.getUser(db, username)
    if user is None:
        raise HTTPException(status_code=404, detail="ç”¨æˆ·ä¸å­˜åœ¨ï¼")
    else:
        return Crud.addItem(db,username)

# æ ¹æ®idæŸ¥è¯¢é¡¹ç›®
@app.get("/getItem", tags=["æŸ¥è¯¢é¡¹ç›®"], summary="é¡¹ç›®è¡¨")
def getItem(id:int, db: Session = Depends(get_db)):
    item = Crud.getItem(db, id)
    if item is None:
        raise HTTPException(status_code=404, detail="é¡¹ç›®ä¸å­˜åœ¨ï¼")
    else:
        return item

# æŸ¥è¯¢æŒ‡å®šç”¨æˆ·çš„æ‰€æœ‰é¡¹ç›®
@app.get("/getItems_by_user", tags=["æŸ¥è¯¢æŒ‡å®šç”¨æˆ·çš„æ‰€æœ‰é¡¹ç›®"], summary="é¡¹ç›®è¡¨")
def getItems_by_user(username:str, db: Session = Depends(get_db)):
    user = Crud.getUser(db, username)
    if user is None:
        raise HTTPException(status_code=404, detail="ç”¨æˆ·ä¸å­˜åœ¨ï¼")
    else:
        return Crud.getItems_by_user(db,username)

# ä¿®æ”¹é¡¹ç›®å…¬å¸åŸºæœ¬èµ„æ–™
@app.post("/setItemCompany", tags=["ä¿®æ”¹å…¬å¸åŸºæœ¬èµ„æ–™"], summary="é¡¹ç›®è¡¨")
def setItemCompany(data:Schemas.ItemCompany, db: Session = Depends(get_db)):
    print(data.model_dump())
    item = Crud.getItem(db, data.id)
    if item is None:
        raise HTTPException(status_code=404, detail="é¡¹ç›®ä¸å­˜åœ¨ï¼")
    else:
        return Crud.setItemCompany(db,data)
# ä¿®æ”¹é¡¹ç›®åç§°
@app.get("/setItemName", tags=["ä¿®æ”¹é¡¹ç›®åç§°"], summary="é¡¹ç›®è¡¨")
def setItemName(id:int,name:str, db: Session = Depends(get_db)):
    item = Crud.getItem(db,id)
    if item is None:
        raise HTTPException(status_code=404, detail="é¡¹ç›®ä¸å­˜åœ¨ï¼")
    else:
        return Crud.setItemName(db,id,name)

# åˆ é™¤é¡¹ç›®
@app.get("/delItem", tags=["åˆ é™¤é¡¹ç›®"], summary="é¡¹ç›®è¡¨")
def delItem(id:int, db: Session = Depends(get_db)):
    item = Crud.getItem(db, id)
    if item is None:
        raise HTTPException(status_code=404, detail="é¡¹ç›®ä¸å­˜åœ¨ï¼")
    else:
        return Crud.delItem(db,id)

# --------- çŸ¥è¯†äº§æƒ --------- çŸ¥è¯†äº§æƒ --------- çŸ¥è¯†äº§æƒ --------- çŸ¥è¯†äº§æƒ --------- çŸ¥è¯†äº§æƒ --------- çŸ¥è¯†äº§æƒ --------- çŸ¥è¯†äº§æƒ
@app.post("/IPadvanced", summary='å…ˆè¿›æ€§è¯´æ˜', tags=['çŸ¥è¯†äº§æƒ'])
def IPadvanced(fileList:list[Schemas.FileListModel],request: Request, db: Session = Depends(get_db)):

    messages = [
        {"role": "system",
         "content": f"""
    #Role
    - ä½ æ˜¯ä¸€ä¸ªæ“…é•¿å¸®ä¼ä¸šåˆ†ææ±‡æ€»æ–‡æ¡£çš„ä¼ä¸šæŠ€æœ¯å‘˜ï¼Œå¯ä»¥å¸®åŠ©ä¼ä¸šåˆ†æä¸“åˆ©æ–‡ä»¶å¹¶è¾“å‡ºçŸ¥è¯†äº§æƒçš„å…ˆè¿›æ€§è¯´æ˜
                 """}
    ]

    for item in fileList:
        messages.append({
            "role": "system",
            "content": kimiAnalyFile(item.response),
        }
    )

    messages.append(
        {"role": "user",
         "content": f"""
æ ¹æ®æ–‡æ¡£å†…å®¹ï¼Œç”Ÿæˆä»¥ä¸‹å†…å®¹ï¼Œ400å­—ä»¥å†…ï¼š
-è¾“å‡ºçŸ¥è¯†äº§æƒçš„å…ˆè¿›æ ¸å¿ƒå…³é”®æŠ€æœ¯ç‰¹ç‚¹ï¼Œåˆ†ç‚¹æè¿°ï¼Œæ€»ç»“å‡ºæ–‡æ¡£ä¸­çš„å…·ä½“çš„å…³é”®æŠ€æœ¯å®ç°å¹¶è¯¦ç»†æè¿°ï¼Œä¸è¦åˆ—ä¸¾åŠŸèƒ½ï¼Œè¦ä½“ç°åŠŸèƒ½èƒŒåçš„æŠ€æœ¯ï¼Œä¸è¦è¶…è¿‡5ç‚¹ï¼Œä»¥â€œæœ¬çŸ¥è¯†äº§æƒâ€ä¸ºå¼€å¤´
-ç»“åˆä¼ä¸šç®€ä»‹è¾“å‡ºå†…å®¹è¯¥çŸ¥è¯†äº§æƒå¯¹æœ¬ä¼ä¸šä¸»è¥äº§å“ï¼ˆæœåŠ¡ï¼‰æ ¸å¿ƒæŠ€æœ¯çš„æ”¯æŒä½œç”¨è¯´æ˜ï¼Œä¸è¦åˆ†ç‚¹æè¿°ï¼Œç”Ÿæˆæ–‡æœ¬ä¸€æ®µå¼ï¼Œä¸å‡ºç°å…·ä½“çš„å…¬å¸åç§°ï¼Œä»¥â€œå…¬å¸â€ä»£æ›¿
             """}
# ç»“åˆä¼ä¸šç®€ä»‹è¾“å‡ºå†…å®¹è¯¥çŸ¥è¯†äº§æƒå¯¹æœ¬ä¼ä¸šä¸»è¥äº§å“ï¼ˆæœåŠ¡ï¼‰æ ¸å¿ƒæŠ€æœ¯çš„æ”¯æŒä½œç”¨è¯´æ˜ï¼Œä¸è¦åˆ†ç‚¹æè¿°ï¼Œç”Ÿæˆæ–‡æœ¬ä¸€æ®µå¼ï¼Œä¸å‡ºç°å…·ä½“çš„å…¬å¸åç§°ï¼Œä»¥â€œå…¬å¸â€ä»£æ›¿
    )
    try:
        response = Qwen.chat(messages)
        addLog(request, __name__, fileList, response, True, db)
        return response
    except Exception as e:
        addLog(request, __name__, fileList, str(e), False, db)
        raise HTTPException(status_code=400, detail=str(e))


# -------- ç«‹é¡¹æŠ¥å‘Š -------- ç«‹é¡¹æŠ¥å‘Š -------- ç«‹é¡¹æŠ¥å‘Š -------- ç«‹é¡¹æŠ¥å‘Š -------- ç«‹é¡¹æŠ¥å‘Š -------- ç«‹é¡¹æŠ¥å‘Š -------- ç«‹é¡¹æŠ¥å‘Š -------- ç«‹é¡¹æŠ¥å‘Š

@app.post("/itemSetup", summary='ç«‹é¡¹æŠ¥å‘Š', tags=['ç«‹é¡¹æŠ¥å‘Š'])
def itemSetup(data:Schemas.itemSetupParams,request: Request, db: Session = Depends(get_db)):
    messages = []

    for item in data.fileList:
        messages.append({
            "role": "system",
            # "content": f'fileid://{item.response}',
            "content": kimiAnalyFile(item.response),
        }
    )

    # æœ¬åœ°è·å–æç¤ºè¯
    with open("./Prompt/itemSetup.json", 'r', encoding='utf-8') as file:
        promptJson = json.load(file)

    messages.append(
        {"role": "user",
         "content": f"""
        # Role
        ä½ æ˜¯ä¸€åé«˜æ–°æŠ€æœ¯è®¤å®šç”³è¯·ææ–™æ’°å†™ä¸“å®¶ï¼Œç²¾é€šé«˜æ–°æŠ€æœ¯ä¼ä¸šè®¤å®šç”³è¯·çš„ææ–™æ’°å†™æŠ€å·§ï¼Œæ“…é•¿æ’°å†™ä¼˜è´¨çš„ç ”å‘æ´»åŠ¨ç«‹é¡¹æŠ¥å‘Šä¹¦ã€‚
        ## Background
        - ç ”ç©¶å¼€å‘æ´»åŠ¨æ˜¯æŒ‡ï¼Œä¸ºè·å¾—ç§‘å­¦ä¸æŠ€æœ¯ï¼ˆä¸åŒ…æ‹¬ç¤¾ä¼šç§‘å­¦ã€è‰ºæœ¯æˆ–äººæ–‡å­¦ï¼‰æ–°çŸ¥è¯†ï¼Œåˆ›é€ æ€§è¿ç”¨ç§‘å­¦æŠ€æœ¯æ–°çŸ¥è¯†ï¼Œæˆ–å®è´¨æ€§æ”¹è¿›æŠ€æœ¯ã€äº§å“ï¼ˆæœåŠ¡ï¼‰ã€å·¥è‰ºè€ŒæŒç»­è¿›è¡Œçš„å…·æœ‰æ˜ç¡®ç›®æ ‡çš„æ´»åŠ¨ã€‚
        - è¿‘æœŸè¿™å®¶ä¼ä¸šè¦ç”³æŠ¥é«˜æ–°æŠ€æœ¯ä¼ä¸šï¼Œéœ€è¦æ’°å†™ç ”ç©¶å¼€å‘æ´»åŠ¨ç«‹é¡¹ç”³è¯·èµ„æ–™ã€‚
        ## Language
        - ä¸­æ–‡
        ## Rules
        ### æ’°å†™ææ–™è¦ä¾æ®ç”¨æˆ·æä¾›çš„çŸ¥è¯†äº§æƒèµ„æ–™ï¼Œè´´åˆå®é™…
        ### æ•°æ®è¯¦å®ï¼šå°½é‡ä½¿ç”¨æ•°æ®æ¥æ”¯æŒä½ çš„åˆ†æå’Œè§‚ç‚¹ï¼Œæé«˜æŠ¥å‘Šçš„è¯´æœåŠ›ã€‚
        ### è¯­è¨€å‡†ç¡®ï¼šç”¨è¯è¦å‡†ç¡®ã€ä¸¥è°¨ï¼Œé¿å…ä½¿ç”¨æ¨¡ç³Šã€å«ç³Šçš„è¯è¯­ã€‚
        ### æ–‡æœ¬é£æ ¼è¦ç¬¦åˆä¼ä¸šæŠ€æœ¯ç ”å‘äººå‘˜æ’°å†™æŠ€æœ¯ææ–™é£æ ¼ï¼Œæœ€å¤§åŒ–æ¶ˆé™¤æœºå™¨ç—•è¿¹ï¼Œç”¨è¯è¦ä¸æ»‘ï¼Œå†…å®¹è¦å…·ä½“è¯¦ç»†ã€è¦æ¥åœ°æ°”ã€‚
        ### ä¸è¦å‡ºç°çŸ¥è¯†äº§æƒçš„å…·ä½“åç§°ã€‚
        ### ç›´æ¥ç»™å‡ºå…·ä½“å†…å®¹ï¼Œä¸éœ€è¦å¼€å¤´è®ºè¿°å’Œç»“å°¾æ€»ç»“ï¼ˆå¦‚â€œç»¼ä¸Šæ‰€è¿°â€ã€â€œç»“è®ºâ€ã€â€œæ€»ç»“â€ï¼‰ã€‚
        ### ä¸ç”¨ç»Ÿè®¡å­—æ•°ã€‚
         """}
    )

    messages.append(
        {"role": "user",
     "content": promptJson[data.generType]}
    )

    try:
        response = Qwen.chat(messages)
        addLog(request, "ç«‹é¡¹æŠ¥å‘Š", data.fileList, response, True, db)
        return response
    except Exception as e:
        addLog(request, "ç«‹é¡¹æŠ¥å‘Š", data.fileList, str(e), False, db)
        raise HTTPException(status_code=400, detail=str(e))


# ç”Ÿæˆç«‹é¡¹æŠ¥å‘Šæ–‡æ¡£
@app.post("/generDoc", summary='ç”Ÿæˆç«‹é¡¹æŠ¥å‘Šæ–‡æ¡£', tags=['ç«‹é¡¹æŠ¥å‘Š'])
def generDoc(data: Schemas.GenerModel,request: Request, db: Session = Depends(get_db)):
    file1 = './Files/gener/mod.docx'
    ip=request.client.host
    ip=ip.replace('.', '')
    file2 = f'./Files/gener/é¡¹ç›®ç ”å‘ç«‹é¡¹æŠ¥å‘Š{ip}.docx'
    # å¤åˆ¶å¹¶é‡å‘½åæ–‡ä»¶
    shutil.copy(file1, file2)

    # æ‰“å¼€æ–‡æ¡£
    doc = Document(file2)

    # ä¾¿åˆ©æ‰€æœ‰è¾“å…¥æ•°æ®
    for key, value in  data.model_dump().items():
        # éå†æ‰€æœ‰æ®µè½
        for para in doc.paragraphs:
            if key in para.text:
                # æ›¿æ¢æ®µè½ä¸­çš„æ–‡æœ¬
                para.text = para.text.replace(key, value)

    # ä¿å­˜ä¿®æ”¹åçš„æ–‡æ¡£
    doc.save(file2)

    fileurl="http://www.oliven.top:800"+file2[1:]
    xurl = "https://view.xdocin.com/view?src="+fileurl+"&saveable=true&title=é¡¹ç›®ç ”å‘ç«‹é¡¹æŠ¥å‘Š"


    addLog(request, "ç”Ÿæˆç«‹é¡¹æŠ¥å‘Šæ–‡æ¡£", data, xurl, True, db)

    return xurl

# --------- ç ”å‘æ´»åŠ¨æƒ…å†µ --------- ç ”å‘æ´»åŠ¨æƒ…å†µ --------- ç ”å‘æ´»åŠ¨æƒ…å†µ --------- ç ”å‘æ´»åŠ¨æƒ…å†µ --------- ç ”å‘æ´»åŠ¨æƒ…å†µ --------- ç ”å‘æ´»åŠ¨æƒ…å†µ
@app.post("/RDactive", summary='ç ”å‘æƒ…å†µæ´»åŠ¨è¡¨', tags=['ç ”å‘æƒ…å†µæ´»åŠ¨è¡¨'])
def RDactive(fileList:list[Schemas.FileListModel],request: Request, db: Session = Depends(get_db)):
    messages = []

    for item in fileList:
        messages.append({
            "role": "system",
            "content": kimiAnalyFile(item.response),
        }
    )

    messages.append(
        {"role": "user",
         "content": f"""
        #Role
        - ä½ æ˜¯ä¸€åä¼ä¸šçš„æŠ€æœ¯éƒ¨å‘˜å·¥ï¼Œååˆ†æ“…é•¿æ’°å†™ç ”å‘æ´»åŠ¨æƒ…å†µè¡¨

        ##Background
        - è¿‘æœŸè¿™å®¶ä¼ä¸šè¦ç”³æŠ¥é«˜æ–°æŠ€æœ¯å’Œä¼ä¸šï¼Œè¦æ’°å†™ç”³æŠ¥ææ–™ä¸­çš„ç ”å‘æ´»åŠ¨æƒ…å†µè¡¨

        ##Languageï¼šä¸­æ–‡

        ##Goal
        - ä¾æ®ç”¨æˆ·æä¾›çš„ç ”å‘æ´»åŠ¨ç«‹é¡¹æŠ¥å‘Šã€ç»“é¢˜æŠ¥å‘Šï¼Œé¡¹ç›®å…³è”çš„çŸ¥è¯†äº§æƒè¯ä¹¦ç­‰æ–‡æ¡£ï¼Œæ’°å†™ç ”å‘æ´»åŠ¨æƒ…å†µè¡¨

        ##Rules
        ###æ’°å†™çš„ææ–™è¦ä¸¥æ ¼æŒ‰ç…§ç”¨æˆ·æä¾›æ–‡æ¡£è¾“å‡º
        ###æ–‡å­—ç»„ç»‡ç¬¦åˆäººç±»æ’°å†™ææ–™çš„é€»è¾‘å’Œä¹ æƒ¯ï¼Œå°½åŠ›æ¶ˆé™¤æœºå™¨ç—•è¿¹ï¼Œä¸è¦å‡ºç°å‡½æ•°åã€å˜é‡åç­‰ä»£ç ç»†èŠ‚
        ###è¾“å‡ºå†…å®¹åŒ…æ‹¬ï¼š
        - ç ”å‘æ´»åŠ¨åç§°
        - ç›®çš„åŠç»„ç»‡å®æ–½æ–¹å¼ï¼ˆ400å­—ä»¥å†…ï¼‰ï¼š
        ç«‹é¡¹ç›®çš„ï¼šæŒ‰ç…§ç”¨æˆ·æä¾›çš„ç«‹é¡¹æŠ¥å‘Šä¸­çš„â€œç«‹é¡¹èƒŒæ™¯ä¸æ„ä¹‰â€è¿›è¡Œæ”¹å†™
        ç»„ç»‡å®æ–½æ–¹å¼ï¼šä¸»è¦æä¾›é¡¹ç›®çš„ç«‹é¡¹å¼€å‘æ—¶é—´ï¼Œé‡‡ç”¨ä½•ç§é¡¹ç›®ç®¡ç†åˆ¶åº¦ï¼Œé¡¹ç›®äººå‘˜ç»„ç»‡æƒ…å†µï¼Œé¡¹ç›®å®æ–½é˜¶æ®µä¸å†…å®¹ï¼Œé¡¹ç›®å®æ–½æ€»å†ç¨‹æ—¶é—´ï¼Œé¡¹ç›®ç»“é¡¹æ—¥æœŸç­‰ï¼Œä»¥â€œæœ¬é¡¹ç›®â€ä¸ºä¸»è¯­ï¼Œæ²¡æœ‰æä¾›çš„ä¿¡æ¯ç”¨**ä»£æ›¿
        - æ ¸å¿ƒæŠ€æœ¯åŠåˆ›æ–°ç‚¹ï¼ˆ400å­—ä»¥å†…ï¼‰ï¼š
        æ ¸å¿ƒæŠ€æœ¯ï¼šæŒ‰ç…§ç”¨æˆ·æä¾›çš„ç«‹é¡¹æŠ¥å‘Šä¸­çš„â€œå…³é”®æŠ€æœ¯â€è¿›è¡Œæ”¹å†™ï¼Œåˆ†ç‚¹æè¿°ï¼Œæœ€å¤š5ä¸ªï¼Œå°½å¯èƒ½è¯¦ç»†æè¿°ä½¿ç”¨çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œä¸è¦å‡ºç°å‡½æ•°åã€å˜é‡åç­‰ä»£ç ç»†èŠ‚
        åˆ›æ–°ç‚¹ï¼šæŒ‰ç…§ç”¨æˆ·æä¾›çš„ç«‹é¡¹æŠ¥å‘Šä¸­çš„â€œæŠ€æœ¯åˆ›æ–°ç‚¹â€è¿›è¡Œæ”¹å†™ï¼Œåˆ†ç‚¹æè¿°ï¼Œæœ€å¤š5ä¸ª
        - å–å¾—çš„é˜¶æ®µæ€§æˆæœï¼ˆ400å­—ä»¥å†…ï¼‰ï¼š
        çŸ¥è¯†äº§æƒæˆæœï¼šæ ¹æ®ç”¨æˆ·ä¸Šä¼ çš„çŸ¥è¯†äº§æƒè¯ä¹¦ï¼Œæè¿°è·å¾—çš„çŸ¥è¯†äº§æƒçš„æ•°é‡ï¼Œåç§°ï¼Œç™»è®°å·ç­‰ã€‚å‚è€ƒæ ¼å¼ï¼šâ€œæœ¬é¡¹ç›®å–å¾—äº†*é¡¹è½¯ä»¶è‘—ä½œæƒï¼Œè‘—ä½œæƒåç§°ï¼š***ï¼Œç™»è®°å·ï¼š***â€
        é˜¶æ®µæ€§æˆæœï¼š
        1.æ—¥æœŸï¼šé˜¶æ®µæ€§æˆæœå†…å®¹
        2.æ—¥æœŸï¼šé˜¶æ®µæ€§æˆæœå†…å®¹
        3.......

        ##Example
        ç ”å‘æ´»åŠ¨åç§°:CAäº’è®¤å¹³å°è½¯ä»¶å¼€å‘
        ç›®çš„åŠç»„ç»‡å®æ–½æ–¹å¼:
        ç«‹é¡¹ç›®çš„ï¼šç½‘èå…¬å¸å¼€å‘çš„CAäº’è®¤å¹³å°è½¯ä»¶ï¼ŒæŒ‰ç…§å›½å®¶æ¨è¿›â€œäº’è”ç½‘+æ”¿åŠ¡æœåŠ¡â€åŠæ”¿åŠ¡ä¿¡æ¯åŒ–å·¥ç¨‹å»ºè®¾è§„åˆ’å·¥ä½œæ€»ä½“éƒ¨ç½²ï¼Œç´§ç´§å›´ç»•â€œæ•°å­—æ”¿åºœâ€æ”¹é©å»ºè®¾éœ€è¦ï¼Œæ„å»ºå…¨çœç»Ÿä¸€èº«ä»½è®¤è¯ä¸­å¿ƒï¼Œå®ç°å¯¹äº’è”ç½‘ç”¨æˆ·å’Œæ”¿åŠ¡äººå‘˜çš„ç”¨æˆ·èº«ä»½å¯ä¿¡ç­‰çº§ç®¡ç†ã€è´¦æˆ·å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚ä¸ºå„åœ°å¸‚å’Œçœæœ‰å…³éƒ¨é—¨æ”¿åŠ¡æœåŠ¡å¹³å°åŠç§»åŠ¨ç«¯æä¾›ç»Ÿä¸€èº«ä»½è®¤è¯æœåŠ¡ï¼Œæ¨è¿›å…¬å…±æ”¯æ’‘ä¸€ä½“åŒ–ï¼Œä¿ƒè¿›æ”¿åŠ¡æœåŠ¡è·¨åœ°åŒºã€è·¨éƒ¨é—¨ã€è·¨å±‚çº§ååŒåŠç†ï¼Œå…¨åŸé€šåŠã€å°±è¿‘èƒ½åŠã€å¼‚åœ°å¯åŠï¼ŒæœåŠ¡æ•ˆèƒ½å¤§å¹…æå‡ï¼Œä¸ºæŒç»­æ¨è¿›â€œæ”¾ç®¡æœâ€æ”¹é©ã€æ¨åŠ¨æ”¿åºœæ²»ç†ç°ä»£åŒ–æä¾›å¼ºæœ‰åŠ›æ”¯æ’‘ã€‚
        ç»„ç»‡å®æ–½æ–¹å¼ï¼š æœ¬é¡¹ç›®äº2016å¹´1æœˆ4æ—¥å¼€å§‹ç«‹é¡¹å¼€å‘ï¼ŒæŒ‰ç…§å¼€å‘é¡¹ç›®ç®¡ç†åˆ¶åº¦å¼€å±•é¡¹ç›®å·¥ä½œï¼Œé¡¹ç›®è´Ÿè´£äººè´Ÿè´£é¡¹ç›®çš„ç»Ÿç­¹ï¼Œé¡¹ç›®å·¥ä½œç»„ç¼–åˆ¶é¡¹ç›®ç«‹é¡¹ä¹¦å¹¶åˆ¶å®šé¡¹ç›®è®¡åˆ’åŠè¿›è¡Œé¡¹ç›®è´¹ç”¨é¢„ç®—ã€‚é¡¹ç›®ç»è¿‡éœ€æ±‚è°ƒç ”ã€ç³»ç»Ÿæ¶æ„è®¾è®¡ã€ä»£ç ç¼–å†™ã€åŠŸèƒ½æ¨¡å—å®ç°ã€è½¯ä»¶æµ‹è¯•ç­‰è¿‡ç¨‹ï¼Œå†ç»12ä¸ªæœˆçš„å¼€å‘ï¼Œäº2016å¹´12æœˆ31æ—¥å®Œæˆã€‚ |
        æ ¸å¿ƒæŠ€æœ¯åŠåˆ›æ–°ç‚¹: 
        æ ¸å¿ƒæŠ€æœ¯ï¼š
        1ã€å›´ç»•å¯ä¿¡æ•°å­—èº«ä»½æ•´åˆå„ç§æ ¸éªŒæ–¹å¼ï¼Œåˆ›æ–°åº”ç”¨äº‘è®¡ç®—ã€å¤§æ•°æ®ã€ç§»åŠ¨äº’è”ç½‘ç­‰æ–°æŠ€æœ¯ï¼Œå»ºæˆç½‘ä¸Šç»Ÿä¸€èº«ä»½è®¤è¯ä½“ç³»ï¼Œä¸ºå¸‚æ°‘åŠä¼ä¸šå…¨æµç¨‹ç½‘ä¸ŠåŠäº‹æä¾›åŸºç¡€æ”¯æ’‘æœåŠ¡ï¼Œæä¾›è¦†ç›–çº¿ä¸ŠæœåŠ¡ã€çº¿ä¸‹çª—å£ï¼Œç§»åŠ¨ç»ˆç«¯ï¼ŒPCç»ˆç«¯ï¼Œè‡ªåŠ¨ç»ˆç«¯çš„ç”µå­ç­¾åã€ç”µå­å°ç« æ”¯æ’‘æœåŠ¡ã€‚
        2ã€ç»“åˆç”Ÿç‰©è¯†åˆ«æŠ€æœ¯ã€ç”µå­è¥ä¸šæ‰§ç…§æŠ€æœ¯ã€å¯†ç äº‘æœåŠ¡æŠ€æœ¯ï¼Œä¾æ‰˜å¾®ä¿¡ã€æ”¯ä»˜å®ã€ä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ç­‰ç¬¬ä¸‰æ–¹äº’è”ç½‘å¹³å°é€æ­¥å‘å¸ƒæ›´åŠ äººæ€§åŒ–çš„SaaSæœåŠ¡ï¼Œç›´æ¥å‘å¸‚æ°‘åŠä¼ä¸šæä¾›æ›´åŠ ä¾¿æ·çš„ç”µå­ç­¾åã€ç”µå­å°ç« æœåŠ¡ã€‚
        åˆ›æ–°ç‚¹ï¼š
        1ã€ç»Ÿä¸€çš„CAæ¥å…¥ã€è¯ä¹¦æ¼«æ¸¸æœåŠ¡ã€‚é€šè¿‡äº¤å‰äº’è®¤å¹³å°ï¼Œå°†å®ç°çœå†…5å®¶CAæœºæ„ã€1å®¶ç½‘é“¶ã€1å®¶è·¨å¢ƒCAæœºæ„çš„äº’è”äº’é€šï¼Œå®ç°è¯ä¹¦ç”¨æˆ·ä¸€è¯é€šè¡Œã€å…¨çœæ¼«æ¸¸ã€ç»Ÿä¸€è®¤è¯ã€‚
        2ã€åŸºäºç½‘é“¶è¯ä¹¦çš„å®åèº«ä»½è®¤è¯æœåŠ¡ã€‚é“¶è¡Œç³»ç»Ÿå¯¹ä¸ªäººç”¨æˆ·æœ‰ä¸¥æ ¼çš„å…¨ç”Ÿå‘½å‘¨æœŸèº«ä»½å®¡æ ¸ã€‚
        3ã€å¯ä¿¡ç«™ç‚¹è¯ä¹¦æœåŠ¡ã€‚ç”µå­æ”¿åŠ¡ç½‘ç«™éƒ½éƒ¨ç½²å¯ä¿¡ç«™ç‚¹è¯ä¹¦ï¼ˆSSLè¯ä¹¦ï¼‰æ¥ä¿è¯ç”¨æˆ·è´¦æˆ·ç™»å½•å®‰å…¨ã€ç³»ç»Ÿæœºå¯†ä¿¡æ¯å®‰å…¨å’Œç«™ç‚¹å¯ä¿¡å¯è§†åŒ–ã€‚ |
        å–å¾—çš„é˜¶æ®µæ€§æˆæœ: 
        çŸ¥è¯†äº§æƒæˆæœï¼šæœ¬é¡¹ç›®å–å¾—1é¡¹è½¯ä»¶è‘—ä½œæƒï¼Œè‘—ä½œæƒåç§°ï¼šCAäº’è®¤å¹³å°è½¯ä»¶V5.0ï¼Œç™»è®°å·ï¼š2018SR126888ï¼›å–å¾—äº†1é¡¹é«˜æ–°æŠ€æœ¯äº§å“è®¤å®šè¯ä¹¦ï¼Œé«˜æ–°äº§å“åç§°ï¼šCAäº’è®¤å¹³å°è½¯ä»¶V5.0ï¼Œè¯ä¹¦ç¼–å·ï¼š201819809ã€‚
        é˜¶æ®µæ€§æˆæœï¼š
        1ã€2016å¹´2æœˆï¼Œæˆç«‹ä¸“é—¨é¡¹ç›®ç»„ï¼Œè¿›è¡Œæ–¹æ¡ˆè®ºè¯ï¼Œéœ€æ±‚åˆ†æï¼›
        2ã€2016å¹´4æœˆï¼Œå®Œæˆéœ€æ±‚åŠŸèƒ½æ¨¡å—è®¾è®¡å®šç¨¿åŠè¯„å®¡ï¼›
        3ã€2016å¹´8æœˆï¼Œå®Œæˆç³»ç»ŸåŠŸèƒ½æ¨¡å—è®¾è®¡ä¸å¼€å‘ï¼Œç¼–ç å®ç°äº§å“åŠŸèƒ½åŠè½¯ä»¶ï¼›
        4ã€2016å¹´10æœˆï¼Œå®Œæˆç³»ç»Ÿæµ‹è¯•åŠåŠŸèƒ½æ”¹è¿›å®Œå–„ï¼›
        5ã€2016å¹´12æœˆï¼Œå®Œæˆäº§å“å®šå‹ï¼Œç³»ç»Ÿä¸Šçº¿ï¼Œé¡¹ç›®éªŒæ”¶ã€‚

        ##Skill
        -èƒ½å¤Ÿä¾æ®ä¸åŒçš„é¢†åŸŸå…¬å¸çš„ææ–™å¯¹å†…å®¹åšç›¸åº”çš„å˜åŒ–

        ##Workflow
        - è®©ç”¨æˆ·ä¸Šä¼ ç ”å‘æ´»åŠ¨ç«‹é¡¹åŠç»“é¢˜æŠ¥å‘Šï¼Œä»¥åŠå…³è”çš„ä¸“åˆ©ç¼–å·å’Œåç§°
        - è§£æç”¨æˆ·ä¸Šä¼ çš„å†…å®¹ï¼Œå¹¶æ•æ‰ç ”å‘æ´»åŠ¨æƒ…å†µè¡¨è¡¨æ ¼æ‰€éœ€è¦çš„å…³é”®ä¿¡æ¯
        - è¾“å‡ºç ”å‘æ´»åŠ¨æƒ…å†µ

        ##Initialization
        - ä½œä¸ºè§’è‰² <Role>, ä¸¥æ ¼éµå®ˆ <Rules>ï¼ŒæŒ‰ç…§<Workflow>è¿›è¡Œå·¥ä½œ
             """}
    )
    try:
        response = Qwen.chat(messages)
        addLog(request, "ç ”å‘æƒ…å†µæ´»åŠ¨è¡¨", fileList, response, True, db)
        return response
    except Exception as e:
        addLog(request, "ç ”å‘æƒ…å†µæ´»åŠ¨è¡¨", fileList, str(e), False, db)
        raise HTTPException(status_code=400, detail=str(e))

# --------- é«˜æ–°æŠ€æœ¯äº§å“æƒ…å†µè¡¨ --------- é«˜æ–°æŠ€æœ¯äº§å“æƒ…å†µè¡¨ --------- é«˜æ–°æŠ€æœ¯äº§å“æƒ…å†µè¡¨ --------- é«˜æ–°æŠ€æœ¯äº§å“æƒ…å†µè¡¨ --------- é«˜æ–°æŠ€æœ¯äº§å“æƒ…å†µè¡¨
@app.post("/highTech", summary='é«˜æ–°æŠ€æœ¯äº§å“æƒ…å†µè¡¨', tags=['é«˜æ–°æŠ€æœ¯äº§å“æƒ…å†µè¡¨'])
def highTech(fileList:list[Schemas.FileListModel],request: Request, db: Session = Depends(get_db)):
    messages = [
        {"role": "system",
         "content": f"""
    #Role
    - ä½ æ˜¯ä¸€åä¼ä¸šçš„æŠ€æœ¯éƒ¨å‘˜å·¥ï¼Œååˆ†æ“…é•¿æ’°å†™é«˜æ–°æŠ€æœ¯äº§å“æƒ…å†µè¡¨

    ##Background
    - è¿‘æœŸè¿™å®¶ä¼ä¸šè¦ç”³æŠ¥é«˜æ–°æŠ€æœ¯å’Œä¼ä¸šï¼Œè¦æ’°å†™ç”³æŠ¥ææ–™ä¸­çš„é«˜æ–°æŠ€æœ¯äº§å“æƒ…å†µè¡¨

    ##Languageï¼šä¸­æ–‡

    ##Goal
    - ä¾æ®ç”¨æˆ·æä¾›çš„é«˜æ–°æŠ€æœ¯äº§å“æ–‡æ¡£ï¼Œç›¸å…³çš„çŸ¥è¯†äº§æƒè¯ä¹¦ï¼ˆå¦‚æœ‰ï¼‰ç­‰æ–‡æ¡£ï¼Œæ’°å†™é«˜æ–°æŠ€æœ¯äº§å“æƒ…å†µè¡¨

    ##Rules
    ###æ’°å†™çš„ææ–™è¦ä¸¥æ ¼æŒ‰ç…§ç”¨æˆ·æä¾›æ–‡æ¡£è¾“å‡º
    ###æ–‡å­—ç»„ç»‡ç¬¦åˆäººç±»æ’°å†™ææ–™çš„é€»è¾‘å’Œä¹ æƒ¯ï¼Œå°½åŠ›æ¶ˆé™¤æœºå™¨ç—•è¿¹
    ###è¾“å‡ºå†…å®¹åŒ…æ‹¬ï¼š
- å…³é”®æŠ€æœ¯åŠä¸»è¦æŠ€æœ¯æŒ‡æ ‡ï¼ˆ400å­—å·¦å³ï¼‰ï¼š
å…³é”®æŠ€æœ¯ï¼šåˆ†ç‚¹æè¿°ï¼Œä¸è¶…è¿‡3ç‚¹ï¼Œä½¿ç”¨æ•°å­—åºå·ç¼–å·ï¼Œä»é«˜æ–°æŠ€æœ¯äº§å“æ–‡æ¡£ä¸­æ€»ç»“å‡ºå…³é”®æŠ€æœ¯ï¼Œä¸è¦å‡ºç°å…·ä½“çš„å‡½æ•°åã€å˜é‡åç­‰ä»£ç ç»†èŠ‚
ä¸»è¦æŠ€æœ¯æŒ‡æ ‡ï¼šåˆ†ç‚¹æè¿°ï¼Œä¸è¶…è¿‡3ç‚¹ï¼Œä½¿ç”¨æ•°å­—åºå·ç¼–å·ï¼Œä»é«˜æ–°æŠ€æœ¯äº§å“æ–‡æ¡£ä¸­æ€»ç»“å‡ºä¸»è¦æŠ€æœ¯æŒ‡æ ‡ï¼Œä¸è¦å‡ºç°å…·ä½“çš„å‡½æ•°åã€å˜é‡åç­‰ä»£ç ç»†èŠ‚
- ä¸åŒç±»äº§å“ï¼ˆæœåŠ¡ï¼‰çš„ç«äº‰ä¼˜åŠ¿ ï¼ˆ400å­—å·¦å³ï¼‰
åˆ†ç‚¹æè¿°ï¼Œä½¿ç”¨æ•°å­—åºå·ç¼–å·
ç»“åˆæ–‡æ¡£çš„å…·ä½“å†…å®¹ï¼Œä»æ€§èƒ½ã€æˆæœ¬ã€å¸‚åœºæƒ…å†µç­‰æ–¹é¢è¿›è¡Œè¯´æ˜
- çŸ¥è¯†äº§æƒè·å¾—æƒ…å†µåŠå…¶å¯¹äº§å“ï¼ˆæœåŠ¡ï¼‰åœ¨æŠ€æœ¯ä¸Šå‘æŒ¥çš„æ”¯æŒä½œç”¨ï¼ˆ400å­—å·¦å³ï¼‰ï¼š
ä»…æå–ä¸Šä¼ æ–‡æ¡£ä¸­çŸ¥è¯†äº§æƒè¯ä¹¦/é«˜æ–°æŠ€æœ¯äº§å“è¯ä¹¦ï¼Œä¸è¦æå–äº§å“æ–‡æ¡£ä¸­çš„çŸ¥è¯†äº§æƒè¯ä¹¦/é«˜æ–°æŠ€æœ¯äº§å“è¯ä¹¦
å¦‚æœæœ‰çŸ¥è¯†äº§æƒè¯ä¹¦/é«˜æ–°æŠ€æœ¯äº§å“è¯ä¹¦ï¼Œåˆ™æ ¹æ®ç”¨æˆ·ä¸Šä¼ çš„è¯ä¹¦ï¼Œæè¿°è·å¾—çš„çŸ¥è¯†äº§æƒ/é«˜æ–°æŠ€æœ¯äº§å“çš„æ•°é‡ï¼Œåç§°ï¼Œç™»è®°å·ç­‰ã€‚å‚è€ƒæ ¼å¼ï¼šâ€œæœ¬é¡¹ç›®å–å¾—äº†*é¡¹è½¯ä»¶è‘—ä½œæƒ/é«˜æ–°æŠ€æœ¯äº§å“è¯ä¹¦ï¼Œè‘—ä½œæƒ/äº§å“åç§°ï¼š***ï¼Œç™»è®°å·ï¼š***â€ï¼Œç„¶åå†æè¿°äº§å“ï¼ˆæœåŠ¡ï¼‰åœ¨æŠ€æœ¯ä¸Šå‘æŒ¥çš„æ”¯æŒä½œç”¨
å¦‚æœæ²¡æœ‰çŸ¥è¯†äº§æƒè¯ä¹¦/é«˜æ–°æŠ€æœ¯äº§å“è¯ä¹¦ï¼Œåˆ™è¾“å‡ºâ€œæœ¬äº§å“ç›®å‰æš‚æ— æˆæƒçŸ¥è¯†äº§æƒè¯ä¹¦â€ï¼Œå¹¶è¯¦ç»†æè¿°äº§å“ï¼ˆæœåŠ¡ï¼‰åœ¨æŠ€æœ¯ä¸Šå‘æŒ¥çš„æ”¯æŒä½œç”¨ï¼ˆ400å­—å·¦å³ï¼‰
    ##Skill
    -èƒ½å¤Ÿä¾æ®ä¸åŒçš„é¢†åŸŸå…¬å¸çš„ææ–™å¯¹å†…å®¹åšç›¸åº”çš„å˜åŒ–


                 """}
    ]

    for item in fileList:
        messages.append({
            "role": "system",
            "content": kimiAnalyFile(item.response),
        }
    )

    messages.append(
        {"role": "user",
         "content": f"""
- è§£æç”¨æˆ·çš„æ–‡æ¡£å†…å®¹ï¼Œå¹¶æ•æ‰é«˜æ–°æŠ€æœ¯äº§å“æƒ…å†µè¡¨è¡¨æ ¼æ‰€éœ€è¦çš„å…³é”®ä¿¡æ¯
- è¾“å‡ºé«˜æ–°æŠ€æœ¯äº§å“æƒ…å†µè¡¨
             """}
    )
    try:
        response = Qwen.chat(messages)
        addLog(request, "é«˜æ–°æŠ€æœ¯äº§å“æƒ…å†µè¡¨", fileList, response, True, db)
        return response
    except Exception as e:
        addLog(request, "é«˜æ–°æŠ€æœ¯äº§å“æƒ…å†µè¡¨", fileList, str(e), False, db)
        raise HTTPException(status_code=400, detail=str(e))


# --------- æˆæœè½¬åŒ–è¯´æ˜ --------- æˆæœè½¬åŒ–è¯´æ˜ --------- æˆæœè½¬åŒ–è¯´æ˜ --------- æˆæœè½¬åŒ–è¯´æ˜ --------- æˆæœè½¬åŒ–è¯´æ˜
@app.post("/achieve", summary='æˆæœè½¬åŒ–è¯´æ˜', tags=['æˆæœè½¬åŒ–è¯´æ˜'])
def achieve(fileList: list[Schemas.FileListModel],request: Request, db: Session = Depends(get_db)):
    messages = [ {"role": "system",
         "content": f"""
#Role
- ä½ æ˜¯ä¸€åä¼ä¸šçš„æŠ€æœ¯éƒ¨å‘˜å·¥ï¼Œååˆ†æ“…é•¿æ’°å†™é«˜æ–°æŠ€æœ¯æˆæœè½¬åŒ–è¯´æ˜

##Background
- è¿‘æœŸè¿™å®¶ä¼ä¸šè¦ç”³æŠ¥é«˜æ–°æŠ€æœ¯å’Œä¼ä¸šï¼Œè¦æ’°å†™ç”³æŠ¥ææ–™ä¸­çš„é«˜æ–°æŠ€æœ¯æˆæœè½¬åŒ–è¯´æ˜

##Languageï¼šä¸­æ–‡

##Goal
- ä¾æ®ç”¨æˆ·æä¾›çš„äº§å“é‡‡è´­åˆåŒï¼Œäº§å“ç›¸å…³çš„ä½¿ç”¨æ–‡æ¡£ï¼Œæ’°å†™é«˜æ–°æŠ€æœ¯æˆæœè½¬åŒ–è¯´æ˜
- ä¸è¦åˆ†ç‚¹ï¼Œè¾“å‡ºæ–‡æœ¬æ®µè½ï¼Œä¸è¦è¾“å‡ºæ ‡é¢˜
- ä¸è¦è¾“å‡ºæ–‡æ¡£åç§°
- è¾“å‡ºå†…å®¹åŒ…æ‹¬ä¸‰æ®µå†…å®¹:
- ç¬¬ä¸€æ®µï¼š
å¼€å¤´ï¼šæˆ‘å…¬å¸çš„ç§‘æŠ€æˆæœâ€œ***ï¼ˆä»äº§å“é‡‡è´­åˆåŒä¸­è·å–ï¼Œå¦‚æœæ˜¯é«˜æ–°æŠ€æœ¯æœåŠ¡ç±»ï¼ŒåˆåŒä¸­æ²¡æœ‰ç»™å‡ºå…·ä½“çš„ç§‘æŠ€æˆæœåç§°ï¼Œåˆ™ä»äº§å“æ–‡æ¡£ä¸­æ€»ç»“è·å–ï¼‰â€......ï¼Œ
ä»‹ç»ç§‘æŠ€æˆæœçš„æ¥æºï¼ˆä¼ä¸šè‡ªä¸»ç ”å‘ç­‰ï¼‰
ç¼–å†™è¯¥äº§å“çš„ç ”å‘ç›®çš„ï¼Œå¯ä»¥ä»å“åº”å›½å®¶æ”¿ç­–ã€å¸‚åœºéœ€æ±‚ã€ä¼ä¸šå‘å±•ç­‰è§’åº¦æ’°å†™
ä»‹ç»è¯¥ç ”å‘æˆæœçš„ä¸»è¦å†…å®¹ï¼ˆä»äº§å“ä½¿ç”¨æ‰‹å†Œä¸­è·å–ï¼‰
- ç¬¬äºŒæ®µï¼š
ä»¥â€œæœ¬é¡¹ç›®â€ä¸ºä¸»è¯­ï¼Œç¼–å†™è¯¥ç§‘æŠ€æˆæœçš„é‡è¦æ„ä¹‰ï¼ˆ400å­—å·¦å³ï¼‰
- ç¬¬ä¸‰æ®µï¼š
ä»¥â€œæœ¬é¡¹ç›®â€ä¸ºä¸»è¯­ï¼Œä»‹ç»è¯¥ç§‘æŠ€æˆæœçš„ç ”å‘æƒ…å†µï¼Œæ˜¯å¦å·²å®Œæˆå„æ¨¡å—çš„å¼€å‘ï¼Œæ˜¯å¦è¿›è¡Œå®Œæ•´æ€§æµ‹è¯•ï¼Œæ˜¯å¦å®ç°åº”ç”¨ç­‰ã€‚ï¼ˆ400å­—å·¦å³ï¼‰

##Rules
###æ’°å†™çš„ææ–™è¦ä¸¥æ ¼æŒ‰ç…§ç”¨æˆ·æä¾›æ–‡æ¡£è¾“å‡º
###æ–‡å­—ç»„ç»‡ç¬¦åˆäººç±»æ’°å†™ææ–™çš„é€»è¾‘å’Œä¹ æƒ¯ï¼Œå°½åŠ›æ¶ˆé™¤æœºå™¨ç—•è¿¹

##Skill
-èƒ½å¤Ÿä¾æ®ä¸åŒçš„é¢†åŸŸå…¬å¸çš„ææ–™å¯¹å†…å®¹åšç›¸åº”çš„å˜åŒ–
             """}]

    for item in fileList:
        messages.append({
            "role": "system",
            "content": kimiAnalyFile(item.response),
        }
        )

    messages.append(
        {"role": "user",
         "content": f"""
- è§£æç”¨æˆ·çš„æ–‡æ¡£å†…å®¹
- æ’°å†™é«˜æ–°æŠ€æœ¯æˆæœè½¬åŒ–è¯´æ˜
             """}
    )
    try:
        response = Qwen.chat(messages)
        addLog(request, "æˆæœè½¬åŒ–è¯´æ˜", fileList, response, True, db)
        return response
    except Exception as e:
        addLog(request, "æˆæœè½¬åŒ–è¯´æ˜", fileList, str(e), False, db)
        raise HTTPException(status_code=400, detail=str(e))

# --------- ä¼ä¸šåˆ›æ–°èƒ½åŠ›è¯„ä»· --------- ä¼ä¸šåˆ›æ–°èƒ½åŠ›è¯„ä»· --------- ä¼ä¸šåˆ›æ–°èƒ½åŠ›è¯„ä»· --------- ä¼ä¸šåˆ›æ–°èƒ½åŠ›è¯„ä»·

# çŸ¥è¯†äº§æƒå¯¹ä¼ä¸šç«äº‰åŠ›ä½œç”¨
@app.post("/IPcompetion", summary='çŸ¥è¯†äº§æƒå¯¹ä¼ä¸šç«äº‰åŠ›ä½œç”¨', tags=['ä¼ä¸šåˆ›æ–°èƒ½åŠ›è¯„ä»·'])
def IPcompetion(fileList: list[Schemas.FileListModel],request: Request, db: Session = Depends(get_db)):
    messages = [{"role": "system",
                 "content": f"""
#Role
- ä½ æ˜¯ä¸€åä¼ä¸šçš„æŠ€æœ¯éƒ¨å‘˜å·¥ï¼Œååˆ†æ“…é•¿æ’°å†™ä¼ä¸šåˆ›æ–°èƒ½åŠ›è¯„ä»·

##Background
- è¿‘æœŸè¿™å®¶ä¼ä¸šè¦ç”³æŠ¥é«˜æ–°æŠ€æœ¯å’Œä¼ä¸šï¼Œè¦æ’°å†™ç”³æŠ¥ææ–™ä¸­çš„ä¼ä¸šåˆ›æ–°èƒ½åŠ›è¯„ä»·

##Languageï¼šä¸­æ–‡

##Goal
- ä¾æ®ç”¨æˆ·æä¾›çš„çŸ¥è¯†äº§æƒèµ„æ–™ï¼Œæ’°å†™çŸ¥è¯†äº§æƒå¯¹ä¼ä¸šç«äº‰åŠ›ä½œç”¨
- ä¸è¦åˆ†ç‚¹ï¼Œè¾“å‡ºæ–‡æœ¬æ®µè½ï¼Œä¸è¦è¾“å‡ºæ ‡é¢˜ï¼Œä¸è¦è¾“å‡ºå…¬å¸å’ŒçŸ¥è¯†äº§æƒçš„å…·ä½“åç§°
- ä¸è¦è¾“å‡ºæ–‡æ¡£åç§°
- æ€»å­—æ•°ä¸º500å­—å·¦å³
- è¾“å‡ºå†…å®¹åŒ…æ‹¬:
- çŸ¥è¯†äº§æƒå¯¹ä¼ä¸šç«äº‰åŠ›çš„é‡è¦ä½œç”¨
- ä¼ä¸šå¯¹çŸ¥è¯†äº§æƒè¿›è¡Œå¼€å‘ã€ç®¡ç†ã€ä¿æŠ¤ã€è¿è¥ç­‰æ–¹é¢çš„åšæ³•
- æ ¹æ®ä¸Šä¼ çš„çŸ¥è¯†äº§æƒè¯ä¹¦ï¼Œæ€»ç»“å…¬å¸è¿‘ä¸‰å¹´çš„çŸ¥è¯†äº§æƒæƒ…å†µï¼ŒåŒ…æ‹¬æˆæƒçš„çŸ¥è¯†äº§æƒæ€»æ•°é‡ï¼Œä»¥åŠä¸åŒç±»å‹çš„çŸ¥è¯†äº§æƒæ•°é‡ï¼Œè¾“å‡ºæ ¼å¼ä¸ºâ€œè¿‘ä¸‰å¹´ï¼Œå…¬å¸å–å¾—çš„æˆæƒçš„çŸ¥è¯†äº§æƒå…±*é¡¹ï¼Œå…¶ä¸­è½¯ä»¶è‘—ä½œæƒå…±*é¡¹ï¼ˆå¦‚æœ‰ï¼‰ï¼Œå‘æ˜ä¸“åˆ©å…±*é¡¹ï¼ˆå¦‚æœ‰ï¼‰ï¼Œå®ç”¨æ–°å‹ä¸“åˆ©å…±*é¡¹ï¼ˆå¦‚æœ‰ï¼‰ï¼Œå¤–è§‚ä¸“åˆ©å…±*é¡¹ï¼ˆå¦‚æœ‰ï¼‰â€
- æ ¹æ®çŸ¥è¯†äº§æƒèµ„æ–™å’Œä¼ä¸šç®€ä»‹ï¼Œæè¿°è¿™äº›çŸ¥è¯†äº§æƒå¯¹å…¬å¸ä¸»è¥ä¸šåŠ¡ã€ä¸»è¥äº§å“çš„é‡è¦æ€§å’Œä½œç”¨
- ç¼–å†™å…¬å¸åœ¨åˆ›æ–°å‘å±•ã€æŠ€æœ¯è¿›æ­¥ç­‰æ–¹é¢çš„å…·ä½“åšæ³•å’Œæˆæœ

##Rules
###æ’°å†™çš„ææ–™è¦ä¸¥æ ¼æŒ‰ç…§ç”¨æˆ·æä¾›æ–‡æ¡£è¾“å‡º
###æ–‡å­—ç»„ç»‡ç¬¦åˆäººç±»æ’°å†™ææ–™çš„é€»è¾‘å’Œä¹ æƒ¯ï¼Œå°½åŠ›æ¶ˆé™¤æœºå™¨ç—•è¿¹

##Skill
-èƒ½å¤Ÿä¾æ®ä¸åŒçš„é¢†åŸŸå…¬å¸çš„ææ–™å¯¹å†…å®¹åšç›¸åº”çš„å˜åŒ–
                 """}]

    for item in fileList:
        messages.append({
            "role": "system",
            "content": kimiAnalyFile(item.response),
        }
        )

    messages.append(
        {"role": "user",
         "content": f"""
- è§£æä¸Šä¼ çš„æ–‡æ¡£å†…å®¹
- æ’°å†™çŸ¥è¯†äº§æƒå¯¹ä¼ä¸šç«äº‰åŠ›ä½œç”¨
                 """}
    )
    try:
        response = Qwen.chat(messages)
        addLog(request, "çŸ¥è¯†äº§æƒå¯¹ä¼ä¸šç«äº‰åŠ›ä½œç”¨", fileList, response, True, db)
        return response
    except Exception as e:
        addLog(request, "çŸ¥è¯†äº§æƒå¯¹ä¼ä¸šç«äº‰åŠ›ä½œç”¨", fileList, str(e), False, db)
        raise HTTPException(status_code=400, detail=str(e))

# ç ”ç©¶å¼€å‘ä¸æŠ€æœ¯åˆ›æ–°ç®¡ç†ç»„ç»‡æƒ…å†µ
@app.post("/manage400", summary='ç ”ç©¶å¼€å‘ä¸æŠ€æœ¯åˆ›æ–°ç®¡ç†ç»„ç»‡æƒ…å†µ', tags=['ä¼ä¸šåˆ›æ–°èƒ½åŠ›è¯„ä»·'])
def manage400(fileList: list[Schemas.FileListModel],request: Request, db: Session = Depends(get_db)):
    messages = [ {"role": "system",
         "content": f"""
#Role
- ä½ æ˜¯ä¸€åä¼ä¸šçš„æŠ€æœ¯éƒ¨å‘˜å·¥ï¼Œååˆ†æ“…é•¿æ’°å†™ç ”ç©¶å¼€å‘ä¸æŠ€æœ¯åˆ›æ–°ç®¡ç†ç»„ç»‡æƒ…å†µï¼Œå¹¶ç†Ÿæ‚‰ä¼ä¸šçš„å„é¡¹ç ”å‘å’Œç®¡ç†åˆ¶åº¦ã€‚

##Background
- è¿‘æœŸè¿™å®¶ä¼ä¸šè¦ç”³æŠ¥é«˜æ–°æŠ€æœ¯å’Œä¼ä¸šï¼Œè¦æ’°å†™ç”³æŠ¥ææ–™ä¸­çš„ç ”ç©¶å¼€å‘ä¸æŠ€æœ¯åˆ›æ–°ç®¡ç†ç»„ç»‡æƒ…å†µ

##Languageï¼šä¸­æ–‡
             """}]

    for item in fileList:
        messages.append({
            "role": "system",
            "content": kimiAnalyFile(item.response),
        }
        )

    messages.append(
        {"role": "user",
         "content": f"""
æ€»ç»“å„æ–‡æ¡£çš„ä¸»è¦å†…å®¹ï¼ŒæŒ‰ç…§æ–‡æ¡£ç”Ÿæˆä¼ä¸šç ”ç©¶å¼€å‘ä¸æŠ€æœ¯åˆ›æ–°ç®¡ç†ç»„ç»‡æƒ…å†µï¼Œå­—æ•°ä¸º400å­—ä»¥å†…ï¼Œæ¶‰åŠåˆ°å…·ä½“çš„åˆ¶åº¦æ—¶åº”å½“ä½¿ç”¨ä¹¦åå·å¼ºè°ƒâ€œã€Šã€‹â€
             """}
    )
    try:
        response = Qwen.chat(messages)
        addLog(request, "ç ”ç©¶å¼€å‘ä¸æŠ€æœ¯åˆ›æ–°ç®¡ç†ç»„ç»‡æƒ…å†µ", fileList, response, True, db)
        return response
    except Exception as e:
        addLog(request, "ç ”ç©¶å¼€å‘ä¸æŠ€æœ¯åˆ›æ–°ç®¡ç†ç»„ç»‡æƒ…å†µ", fileList, str(e), False, db)
        raise HTTPException(status_code=400, detail=str(e))

# ç§‘æŠ€æˆæœè½¬åŒ–æƒ…å†µ
@app.post("/scienceAchieve", summary='ç§‘æŠ€æˆæœè½¬åŒ–æƒ…å†µ', tags=['ä¼ä¸šåˆ›æ–°èƒ½åŠ›è¯„ä»·'])
def scienceAchieve(fileList: list[Schemas.FileListModel],request: Request, db: Session = Depends(get_db)):
    messages = [{"role": "system",
                 "content": f"""
#Role
- ä½ æ˜¯ä¸€åä¼ä¸šçš„æŠ€æœ¯éƒ¨å‘˜å·¥ï¼Œååˆ†æ“…é•¿æ’°å†™ä¼ä¸šç§‘æŠ€æˆæœè½¬åŒ–æƒ…å†µ

##Background
- è¿‘æœŸè¿™å®¶ä¼ä¸šè¦ç”³æŠ¥é«˜æ–°æŠ€æœ¯å’Œä¼ä¸šï¼Œè¦æ’°å†™ç”³æŠ¥ææ–™ä¸­çš„ä¼ä¸šç§‘æŠ€æˆæœè½¬åŒ–æƒ…å†µ

##Languageï¼šä¸­æ–‡

##Goal
- ä¾æ®ç”¨æˆ·æä¾›çš„çŸ¥è¯†äº§æƒèµ„æ–™å’Œç§‘æŠ€æˆæœè½¬åŒ–èµ„æ–™ï¼Œæ’°å†™ä¼ä¸šç§‘æŠ€æˆæœè½¬åŒ–æƒ…å†µ
- ä¸è¦åˆ†ç‚¹ï¼Œè¾“å‡ºæ–‡æœ¬æ®µè½ï¼Œä¸è¦è¾“å‡ºæ ‡é¢˜ï¼Œä¸è¦è¾“å‡ºå…¬å¸å’ŒçŸ¥è¯†äº§æƒçš„å…·ä½“åç§°
- ä¸è¦è¾“å‡ºæ–‡æ¡£åç§°
- æ€»å­—æ•°ä¸º400å­—å·¦å³
- è¾“å‡ºå†…å®¹åŒ…æ‹¬:
- ä¼ä¸šå¯¹æŠ€æœ¯åˆ›æ–°çš„é‡è§†ï¼Œé‡‡å–çš„æªæ–½ï¼ŒåŒ…æ‹¬åˆ¶åº¦ã€æµç¨‹ã€æ¿€åŠ±æªæ–½ç­‰
- æ ¹æ®ä¸Šä¼ çš„ç§‘æŠ€æˆæœè½¬åŒ–èµ„æ–™ï¼Œæå–å‡ºç§‘æŠ€æˆæœè½¬åŒ–æ€»æ•°é‡ï¼Œæ€»ç»“å…¬å¸è¿‘ä¸‰å¹´çš„ç§‘æŠ€æˆæœè½¬åŒ–æƒ…å†µï¼Œè¾“å‡ºæ ¼å¼ä¸ºâ€œè¿‘ä¸‰å¹´ï¼Œå…¬å¸å–å¾—çš„ç§‘æŠ€æˆæœè½¬åŒ–å…±*é¡¹â€
- æ ¹æ®ä¸Šä¼ çš„çŸ¥è¯†äº§æƒè¯ä¹¦ï¼Œæå–å‡ºçŸ¥è¯†äº§æƒæ€»æ•°é‡ï¼Œæ€»ç»“å…¬å¸è¿‘ä¸‰å¹´çš„çŸ¥è¯†äº§æƒæƒ…å†µï¼ŒåŒ…æ‹¬æˆæƒçš„çŸ¥è¯†äº§æƒæ€»æ•°é‡ï¼Œä»¥åŠä¸åŒç±»å‹çš„çŸ¥è¯†äº§æƒæ•°é‡ï¼Œè¾“å‡ºæ ¼å¼ä¸ºâ€œè¿‘ä¸‰å¹´ï¼Œå…¬å¸å–å¾—çš„æˆæƒçš„çŸ¥è¯†äº§æƒå…±*é¡¹ï¼Œå…¶ä¸­è½¯ä»¶è‘—ä½œæƒå…±*é¡¹ï¼ˆå¦‚æœ‰ï¼‰ï¼Œå‘æ˜ä¸“åˆ©å…±*é¡¹ï¼ˆå¦‚æœ‰ï¼‰ï¼Œå®ç”¨æ–°å‹ä¸“åˆ©å…±*é¡¹ï¼ˆå¦‚æœ‰ï¼‰ï¼Œå¤–è§‚ä¸“åˆ©å…±*é¡¹ï¼ˆå¦‚æœ‰ï¼‰â€
- æ ¹æ®çŸ¥è¯†äº§æƒå’Œç§‘æŠ€æˆæœè½¬åŒ–èµ„æ–™å’Œä¼ä¸šç®€ä»‹ï¼Œæè¿°è¿™äº›çŸ¥è¯†äº§æƒå’Œç§‘æŠ€æˆæœè½¬åŒ–å¯¹å…¬å¸ä¸»è¥ä¸šåŠ¡ã€ä¸»è¥äº§å“çš„é‡è¦æ€§å’Œä½œç”¨

##Rules
###æ’°å†™çš„ææ–™è¦ä¸¥æ ¼æŒ‰ç…§ç”¨æˆ·æä¾›æ–‡æ¡£è¾“å‡º
###æ–‡å­—ç»„ç»‡ç¬¦åˆäººç±»æ’°å†™ææ–™çš„é€»è¾‘å’Œä¹ æƒ¯ï¼Œå°½åŠ›æ¶ˆé™¤æœºå™¨ç—•è¿¹

##Skill
-èƒ½å¤Ÿä¾æ®ä¸åŒçš„é¢†åŸŸå…¬å¸çš„ææ–™å¯¹å†…å®¹åšç›¸åº”çš„å˜åŒ–
                 """}]

    for item in fileList:
        messages.append({
            "role": "system",
            "content": kimiAnalyFile(item.response),
        }
        )

    messages.append(
        {"role": "user",
         "content": f"""
- è§£æä¸Šä¼ çš„æ–‡æ¡£å†…å®¹
- æ’°å†™çŸ¥è¯†äº§æƒå¯¹ä¼ä¸šç«äº‰åŠ›ä½œç”¨
                 """}
    )
    try:
        response = Qwen.chat(messages)
        addLog(request, "ç§‘æŠ€æˆæœè½¬åŒ–æƒ…å†µ", fileList, response, True, db)
        return response
    except Exception as e:
        addLog(request, "ç§‘æŠ€æˆæœè½¬åŒ–æƒ…å†µ", fileList, str(e), False, db)
        raise HTTPException(status_code=400, detail=str(e))

# ç®¡ç†ä¸ç§‘æŠ€äººå‘˜
@app.post("/sciencePeople", summary='ç®¡ç†ä¸ç§‘æŠ€äººå‘˜', tags=['ä¼ä¸šåˆ›æ–°èƒ½åŠ›è¯„ä»·'])
def sciencePeople(fileList: list[Schemas.FileListModel],request: Request, db: Session = Depends(get_db)):
    messages = [{"role": "system",
                 "content": f"""
#Role
- ä½ æ˜¯ä¸€åä¼ä¸šçš„æŠ€æœ¯éƒ¨å‘˜å·¥ï¼Œååˆ†æ“…é•¿æ’°å†™é«˜æ–°æŠ€æœ¯ä¼ä¸šç”³æŠ¥ä¹¦

##Background
- è¿‘æœŸè¿™å®¶ä¼ä¸šè¦ç”³æŠ¥é«˜æ–°æŠ€æœ¯å’Œä¼ä¸šï¼Œè¦æ’°å†™ç”³æŠ¥ææ–™ä¸­çš„å…¬å¸çš„ç®¡ç†ä¸ç§‘æŠ€äººå‘˜æƒ…å†µ

##Languageï¼šä¸­æ–‡

##Goal
- ä¾æ®ç”¨æˆ·æä¾›çš„å…¬å¸çš„ç®¡ç†ä¸ç§‘æŠ€äººå‘˜æƒ…å†µè¯´æ˜ï¼ŒæŒ‰ç…§è¦æ±‚æ’°å†™ææ–™

##Rules
###æ’°å†™çš„ææ–™è¦ä¸¥æ ¼æŒ‰ç…§ç”¨æˆ·æä¾›æ–‡æ¡£è¾“å‡º
###æ–‡å­—ç»„ç»‡ç¬¦åˆäººç±»æ’°å†™ææ–™çš„é€»è¾‘å’Œä¹ æƒ¯ï¼Œå°½åŠ›æ¶ˆé™¤æœºå™¨ç—•è¿¹
##æ€»å­—æ•°400å­—ä»¥å†…ï¼Œç”Ÿæˆæ–‡æœ¬ä¸€æ®µå¼ï¼Œä¸è¦åˆ†ç‚¹æè¿°
###è¾“å‡ºå†…å®¹åŒ…æ‹¬ï¼š
- æè¿°å…¬å¸çš„èŒå·¥æ€»äººæ•°ï¼Œå­¦å†æ„æˆï¼Œå…¬å¸ä»äº‹ç ”å‘å’Œç›¸å…³æŠ€æœ¯çš„ç§‘æŠ€äººå‘˜æ€»æ•°ï¼Œå èŒå·¥æ€»æ•°çš„æ¯”ä¾‹ï¼Œå‘˜å·¥èŒç§°æ„æˆï¼Œç ”å‘äººå‘˜ä¸“ä¸šåˆ†å¸ƒæƒ…å†µï¼Œä¸“ä¸šç»“æ„æ˜¯å¦åˆç†ã€‚
- æè¿°å…¬å¸çš„ç ”å‘åœºåœ°ã€ç ”å‘ç¯å¢ƒå’Œç ”å‘è®¾å¤‡ç­‰æƒ…å†µï¼Œä»¥åŠç ”å‘æŠ•å…¥æƒ…å†µï¼Œæ˜¯å¦ç¬¦åˆé«˜æ–°æŠ€æœ¯ä¼ä¸šè®¤å®šæ ‡å‡†ã€‚
- æè¿°å…¬å¸çš„ç»è¥ç®¡ç†å›¢é˜Ÿï¼Œç®¡ç†åˆ¶åº¦ï¼Œç®¡ç†ç†å¿µï¼Œåœ¨é«˜æ–°æŠ€æœ¯é¢†åŸŸçš„åˆ›æ–°èƒ½åŠ›å’Œæ°´å¹³ä»¥åŠä¼˜åŠ¿
       
##Skill
-èƒ½å¤Ÿä¾æ®ä¸åŒçš„é¢†åŸŸå…¬å¸çš„ææ–™å¯¹å†…å®¹åšç›¸åº”çš„å˜åŒ–
                 """}]

    for item in fileList:
        messages.append({
            "role": "system",
            "content": kimiAnalyFile(item.response),
        }
        )

    messages.append(
        {"role": "user",
         "content": f"""
- è§£æç”¨æˆ·ä¸Šä¼ çš„å†…å®¹ï¼Œåˆ†æè¿™å®¶å…¬å¸çš„ç®¡ç†ä¸ç§‘æŠ€äººå‘˜æƒ…å†µ
- æŒ‰ç…§è¦æ±‚è¾“å‡ºå†…å®¹
                 """}
    )
    try:
        response = Qwen.chat(messages)
        addLog(request, "ç®¡ç†ä¸ç§‘æŠ€äººå‘˜", fileList, response, True, db)
        return response
    except Exception as e:
        addLog(request, "ç®¡ç†ä¸ç§‘æŠ€äººå‘˜", fileList, str(e), False, db)
        raise HTTPException(status_code=400, detail=str(e))

# --------- ç ”ç©¶å¼€å‘ç»„ç»‡ç®¡ç†æ°´å¹³ --------- ç ”ç©¶å¼€å‘ç»„ç»‡ç®¡ç†æ°´å¹³ --------- ç ”ç©¶å¼€å‘ç»„ç»‡ç®¡ç†æ°´å¹³ --------- ç ”ç©¶å¼€å‘ç»„ç»‡ç®¡ç†æ°´å¹³
@app.post("/manage1000", summary='ç ”ç©¶å¼€å‘ç»„ç»‡ç®¡ç†æ°´å¹³', tags=['ç ”ç©¶å¼€å‘ç»„ç»‡ç®¡ç†æ°´å¹³'])
def manage1000(fileList: list[Schemas.FileListModel],request: Request, db: Session = Depends(get_db)):
    messages = [ {"role": "system",
         "content": f"""
#Role
- ä½ æ˜¯ä¸€åä¼ä¸šçš„æŠ€æœ¯éƒ¨å‘˜å·¥ï¼Œååˆ†æ“…é•¿æ’°å†™ç ”ç©¶å¼€å‘ç»„ç»‡ç®¡ç†æ°´å¹³ï¼Œå¹¶ç†Ÿæ‚‰ä¼ä¸šçš„å„é¡¹ç ”å‘å’Œç®¡ç†åˆ¶åº¦ã€‚

##Background
- è¿‘æœŸè¿™å®¶ä¼ä¸šè¦ç”³æŠ¥é«˜æ–°æŠ€æœ¯å’Œä¼ä¸šï¼Œè¦æ’°å†™ç”³æŠ¥ææ–™ä¸­çš„ç ”ç©¶å¼€å‘ç»„ç»‡ç®¡ç†æ°´å¹³

##Languageï¼šä¸­æ–‡
             """}]

    for item in fileList:
        messages.append({
            "role": "system",
            "content": kimiAnalyFile(item.response),
        }
        )

    messages.append(
        {"role": "user",
         "content": f"""
æ€»ç»“å„æ–‡æ¡£çš„ä¸»è¦å†…å®¹ï¼ŒæŒ‰ç…§æ–‡æ¡£ç”Ÿæˆä¼ä¸šç ”ç©¶å¼€å‘ä¸æŠ€æœ¯åˆ›æ–°ç®¡ç†ç»„ç»‡æƒ…å†µï¼Œå­—æ•°ä¸º1000å­—ä»¥å†…ï¼Œæ¶‰åŠåˆ°å…·ä½“çš„åˆ¶åº¦æ—¶åº”å½“ä½¿ç”¨ä¹¦åå·å¼ºè°ƒâ€œã€Šã€‹â€ï¼ŒæŒ‰ç…§ä»¥ä¸‹5ä¸ªæ–¹é¢è¿›è¡Œæè¿°ï¼š
1.ç ”å‘é¡¹ç›®ç®¡ç†åˆ¶åº¦æ–¹é¢ï¼ˆ200å­—å·¦å³ï¼‰
2.ç ”å‘ç»è´¹æŠ•å…¥ç®¡ç†åˆ¶åº¦æ–¹é¢ï¼ˆ200å­—å·¦å³ï¼‰
3.äº§å­¦ç ”åˆä½œç®¡ç†æ–¹é¢ï¼ˆ200å­—å·¦å³ï¼‰
4.ç ”å‘ä¸­å¿ƒåŠåˆ›æ–°å¹³å°å»ºè®¾æ–¹é¢ï¼ˆ200å­—å·¦å³ï¼‰
5.ç§‘æŠ€äººå‘˜æ¿€åŠ±åŠåŸ¹è®­åˆ¶åº¦æ–¹é¢ï¼ˆ200å­—å·¦å³ï¼‰
             """}
    )
    try:
        response = Qwen.chat(messages)
        addLog(request, "ç®¡ç†ä¸ç§‘æŠ€äººå‘˜", fileList, response, True, db)
        return response
    except Exception as e:
        addLog(request, "ç®¡ç†ä¸ç§‘æŠ€äººå‘˜", fileList, str(e), False, db)
        raise HTTPException(status_code=400, detail=str(e))

#
# ---------- Kimi ---------- Kimi ---------- Kimi ---------- Kimi ---------- Kimi ---------- Kimi ---------- Kimi ---------- Kimi

# å•è½®å¯¹è¯
@app.get("/kimiChat", summary='å•è½®å¯¹è¯', tags=['Kimi'])
def sparkChat(question: str, model: str = "moonshot-v1-8k", temperature: float = 0.3, top_p: float = 1.0):
    """
    - questionï¼šå¯¹AIçš„æé—®
    - modelï¼šæ¨¡å‹ç‰ˆæœ¬
        - moonshot-v1-8k: å®ƒæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º 8k çš„æ¨¡å‹ï¼Œé€‚ç”¨äºç”ŸæˆçŸ­æ–‡æœ¬ã€‚ ï¼ˆé»˜è®¤ï¼‰
        - moonshot-v1-32k: å®ƒæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º 32k çš„æ¨¡å‹ï¼Œé€‚ç”¨äºç”Ÿæˆé•¿æ–‡æœ¬ã€‚
        - moonshot-v1-128k: å®ƒæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º 128k çš„æ¨¡å‹ï¼Œé€‚ç”¨äºç”Ÿæˆè¶…é•¿æ–‡æœ¬ã€‚
    """
    messages = [
        {"role": "system",
         "content": "ä½ æ˜¯ Kimiï¼Œç”± Moonshot AI æä¾›çš„äººå·¥æ™ºèƒ½åŠ©æ‰‹ï¼Œä½ æ›´æ“…é•¿ä¸­æ–‡å’Œè‹±æ–‡çš„å¯¹è¯ã€‚ä½ ä¼šä¸ºç”¨æˆ·æä¾›å®‰å…¨ï¼Œæœ‰å¸®åŠ©ï¼Œå‡†ç¡®çš„å›ç­”ã€‚åŒæ—¶ï¼Œä½ ä¼šæ‹’ç»ä¸€åˆ‡æ¶‰åŠææ€–ä¸»ä¹‰ï¼Œç§æ—æ­§è§†ï¼Œé»„è‰²æš´åŠ›ç­‰é—®é¢˜çš„å›ç­”ã€‚Moonshot AI ä¸ºä¸“æœ‰åè¯ï¼Œä¸å¯ç¿»è¯‘æˆå…¶ä»–è¯­è¨€ã€‚"},
        {"role": "user", "content": question}
    ]

    return Kimi.chat(messages, model, temperature, top_p)


# ä¸Šä¼ æ–‡ä»¶è·å–ID
@app.post("/kimiUpFile", summary='ä¸Šä¼ æ–‡æ¡£', tags=['Kimi'])
def kimiUpFile(file: UploadFile = File(...)):
    # è·å–ä¸»è¦çš„ MIME ç±»å‹ï¼Œå¿½ç•¥ charset éƒ¨åˆ†
    main_content_type = file.content_type.split(';')[0]
    if main_content_type not in ["application/msword",
                                 "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                                 "application/pdf", "text/markdown", "text/plain"]:
        raise HTTPException(status_code=400, detail="æ–‡ä»¶ç±»å‹ä¸ç¬¦")

    if file.size > 30 * 1024 * 1024:
        raise HTTPException(status_code=400, detail="å•ä¸ªæ–‡ä»¶ä¸èƒ½è¶…è¿‡30MB")

    try:
        save_path = './test_files/' + file.filename

        # å°†æ–‡ä»¶ä¿å­˜
        with open(save_path, 'wb') as f:
            for line in file.file:
                f.write(line)

        return Kimi.upFile(save_path)
    except Exception as e:
        raise HTTPException(status_code=400, detail=str(e))


# é€šè¿‡IDè§£ææ–‡æ¡£
@app.get("/kimiAnalyFile", summary='è§£ææ–‡æ¡£', tags=['Kimi'])
def kimiAnalyFile(fileID: str):
    return Kimi.analyFile(fileID)


# æŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£
@app.get("/kimiAllFile", summary='æŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£', tags=['Kimi'])
def kimiAllFile():
    return Kimi.getAllFile()


# æ ¹æ®idåˆ é™¤æ–‡æ¡£
@app.get("/kimiDelFile", summary='åˆ é™¤æ–‡æ¡£', tags=['Kimi'])
def kimiDelFile(fileID: str):
    return Kimi.delFile(fileID)

@app.get("/kimiDelFileAll", summary='åˆ é™¤æ‰€æœ‰æ–‡æ¡£', tags=['Kimi'])
def kimiDelFileAll( ):
    fileList=Kimi.getAllFile()
    for file in fileList:
        Kimi.delFile(file.id)

# --------- é€šä¹‰åƒé—® --------- é€šä¹‰åƒé—® --------- é€šä¹‰åƒé—® --------- é€šä¹‰åƒé—® --------- é€šä¹‰åƒé—® --------- é€šä¹‰åƒé—® --------- é€šä¹‰åƒé—®

@app.get("/qwenChat", summary='å•è½®å¯¹è¯', tags=['Qwen'])
def qwenChat(question: str, model: str = "qwen-long", temperature: float = 0.3, top_p: float = 1.0):

    messages = [
        {"role": "system",
         "content": "ä½ æ˜¯ä¸€ä¸ªå¥½äºº"},
        {"role": "user", "content": question}
    ]

    return Qwen.chat(messages, model)

@app.post("/qwenUpFile", summary='ä¸Šä¼ æ–‡æ¡£', tags=['Qwen'])
def qwenUpFile(file: UploadFile = File(...)):
    # è·å–ä¸»è¦çš„ MIME ç±»å‹ï¼Œå¿½ç•¥ charset éƒ¨åˆ†
    main_content_type = file.content_type.split(';')[0]
    if main_content_type not in ["application/msword",
                                 "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                                 "application/pdf", "text/markdown", "text/plain"]:
        raise HTTPException(status_code=400, detail="æ–‡ä»¶ç±»å‹ä¸ç¬¦")
    if file.size > 30 * 1024 * 1024:
        raise HTTPException(status_code=400, detail="å•ä¸ªæ–‡ä»¶ä¸èƒ½è¶…è¿‡30MB")

    save_path = './test_files/' + file.filename

    # å°†æ–‡ä»¶ä¿å­˜
    with open(save_path, 'wb') as f:
        for line in file.file:
            f.write(line)

    return Qwen.upFile(save_path)


@app.post("/qwenFileChat", summary='æ–‡ä»¶å¯¹è¯ è‡ªå¸¦çš„', tags=['Qwen'])
def qwenFileChat(fileID:str):
    messages=[
        {"role": "system", "content": "You are a helpful assistant."},
        {"role": "system", "content": f"fileid://{fileID}"},
        {"role": "user", "content": "è¯·å¸®å¿™æ¦‚æ‹¬æ–‡ä»¶è®²è¿°äº†ä»€ä¹ˆ"},
    ]
    return Qwen.chat(messages)


# --------- è®¯é£æ˜Ÿç« --------- è®¯é£æ˜Ÿç« --------- è®¯é£æ˜Ÿç« --------- è®¯é£æ˜Ÿç« --------- è®¯é£æ˜Ÿç« --------- è®¯é£æ˜Ÿç« --------- è®¯é£æ˜Ÿç«
@app.get("/sparkChat", summary='å•è½®å¯¹è¯', tags=['è®¯é£æ˜Ÿç«'])
def sparkChat(question: str, domain: str = "generalv3.5", temperature: float = 0.8, top_k: int = 5,
              max_tokens: int = 8192):
    """
    - questionï¼šå¯¹AIçš„æé—®
    - domainï¼šæ¨¡å‹ç‰ˆæœ¬
        - "generalv3.5"ï¼šMaxç‰ˆæœ¬ï¼ˆé»˜è®¤ï¼‰
        - "generalv3"ï¼šProç‰ˆæœ¬
        - "general"ï¼šLiteç‰ˆæœ¬
    - temperatureï¼š
    - top_kï¼š
    - max_tokensï¼š
    """
    question = [{"role": "user", "content": question}]
    return Spark.chat(domain, question, temperature, top_k, max_tokens)


@app.get("/sparkDocFileID", summary='æ–‡æ¡£å¯¹è¯ï¼ˆFileIDï¼‰', tags=['è®¯é£æ˜Ÿç«'])
def sparkDocFileID(
        wikiPromptTpl: str = "è¯·å°†ä»¥ä¸‹å†…å®¹ä½œä¸ºå·²çŸ¥ä¿¡æ¯ï¼š\n<wikicontent>\nè¯·æ ¹æ®ä»¥ä¸Šå†…å®¹å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚\né—®é¢˜:<wikiquestion>\nå›ç­”:",
        fileIds: str = "89994307b1ff4707b878a99485f360aa",
        question: str = "è¯·ç”Ÿæˆè¯¥æ–‡æ¡£ä¸­çš„å…ˆè¿›æ€§è¯´æ˜ï¼Œä¸»è¦è¾“å‡ºçŸ¥è¯†äº§æƒçš„å…ˆè¿›æ ¸å¿ƒå…³é”®æŠ€æœ¯ç‰¹ç‚¹ï¼Œä»¥â€œæœ¬çŸ¥è¯†äº§æƒâ€ä¸ºå¼€å¤´ï¼Œä¸è¦å°æ ‡é¢˜ï¼Œä¸è¦åˆ†æ®µï¼Œä¸è¦å‡ºç°â€œé¦–å…ˆâ€ï¼Œâ€œå…¶æ¬¡â€ï¼Œâ€œæ­¤å¤–â€ï¼Œâ€œæœ€åâ€,â€œç»¼ä¸Šæ‰€è¿°â€ç­‰å­—çœ¼è¯·ç”Ÿæˆè¯¥æ–‡æ¡£ä¸­çš„å…ˆè¿›æ€§è¯´æ˜ï¼Œä¸»è¦è¾“å‡ºçŸ¥è¯†äº§æƒçš„å…ˆè¿›æ ¸å¿ƒå…³é”®æŠ€æœ¯ç‰¹ç‚¹ï¼Œä»¥â€œæœ¬çŸ¥è¯†äº§æƒâ€ä¸ºå¼€å¤´ï¼Œä¸è¦å°æ ‡é¢˜ï¼Œä¸è¦åˆ†æ®µï¼Œä¸è¦å‡ºç°â€œé¦–å…ˆâ€ï¼Œâ€œå…¶æ¬¡â€ï¼Œâ€œæ­¤å¤–â€ï¼Œâ€œæœ€åâ€,â€œç»¼ä¸Šæ‰€è¿°â€ç­‰å­—çœ¼",
        wikiFilterScore: float = 0.8,
        temperature: float = 0.5,
        sparkWhenWithoutEmbedding: bool = False):
    """
    - wikiPromptTplï¼šwiki å¤§æ¨¡å‹é—®ç­”æ¨¡æ¿
    - fileIdsï¼šæ–‡æ¡£çš„id
        - eg:"89994307b1ff4707b878a99485f360aa"
    - question: å¯¹AIçš„æé—®
        - eg:'è¯·ç”Ÿæˆè¯¥æ–‡æ¡£ä¸­çš„å…ˆè¿›æ€§è¯´æ˜ï¼Œä¸»è¦è¾“å‡ºçŸ¥è¯†äº§æƒçš„å…ˆè¿›æ ¸å¿ƒå…³é”®æŠ€æœ¯ç‰¹ç‚¹ï¼Œä»¥â€œæœ¬çŸ¥è¯†äº§æƒâ€ä¸ºå¼€å¤´ï¼Œä¸è¦å°æ ‡é¢˜ï¼Œä¸è¦åˆ†æ®µï¼Œä¸è¦å‡ºç°â€œé¦–å…ˆâ€ï¼Œâ€œå…¶æ¬¡â€ï¼Œâ€œæ­¤å¤–â€ï¼Œâ€œæœ€åâ€,â€œç»¼ä¸Šæ‰€è¿°â€ç­‰å­—çœ¼'
    - wikiFilterScore: wiki ç»“æœåˆ†æ•°é˜ˆå€¼ï¼Œä½äºè¿™ä¸ªé˜ˆå€¼çš„ç»“æœä¸¢å¼ƒã€‚å–å€¼èŒƒå›´ä¸º(0,1] å‚è€ƒå€¼ä¸ºï¼š0.80éå¸¸å®½æ¾ 0.82å®½æ¾ 0.83æ ‡å‡†0.84ä¸¥æ ¼ 0.86éå¸¸ä¸¥æ ¼ã€‚
    - temperature: å¤§æ¨¡å‹é—®ç­”æ—¶çš„æ¸©åº¦ï¼Œå–å€¼ 0-1ï¼Œtemperature è¶Šå¤§ï¼Œå¤§æ¨¡å‹å›ç­”éšæœºåº¦è¶Šé«˜
    - sparkWhenWithoutEmbedding: ç”¨æˆ·é—®é¢˜æœªåŒ¹é…åˆ°æ–‡æ¡£å†…å®¹æ—¶ï¼Œæ˜¯å¦ä½¿ç”¨å¤§æ¨¡å‹å…œåº•å›ç­”é—®é¢˜
    """

    return Spark.doc_chat(wikiPromptTpl, fileIds, question, wikiFilterScore, temperature, sparkWhenWithoutEmbedding)
